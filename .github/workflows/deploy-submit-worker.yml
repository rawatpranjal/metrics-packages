name: Deploy Submit Worker

on:
  push:
    branches: ["main"]
    paths:
      - 'submit-worker/**'
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Submit Worker

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy Worker
        working-directory: ./submit-worker
        run: wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Health Check
        run: |
          sleep 5
          curl -s https://tech-econ-submit.rawat-pranjal010.workers.dev/health | grep -q '"status":"ok"' && echo "Worker healthy" || echo "Worker may need attention"
