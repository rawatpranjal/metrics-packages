{{ define "main" }}
<div class="container">
    <!-- Search and Filters Row -->
    <div class="search-filters-row">
        <!-- Search Bar -->
        <div class="search-container">
            <div class="search-input-wrapper">
                <svg class="search-icon" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="text"
                       id="community-search"
                       class="search-input"
                       placeholder="Search events and communities..."
                       autocomplete="off">
                <button id="clear-search" class="clear-btn" type="button" aria-label="Clear search">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Category Dropdown -->
        {{ $categoryOrder := slice "Conferences" "Networking" "Online" }}
        <select id="category-select" class="category-select">
            <option value="all">All Categories</option>
            {{ range $cat := $categoryOrder }}
            <option value="{{ $cat }}">{{ $cat }}</option>
            {{ end }}
        </select>

        <!-- View Toggle -->
        <div class="view-toggle">
            <button id="btn-calendar" class="toggle-btn active">Calendar</button>
            <button id="btn-cards" class="toggle-btn">Cards</button>
        </div>
    </div>

    <div id="result-count" class="result-count">{{ len .Site.Data.community }} events & communities</div>

    <!-- Calendar View (default) -->
    <div id="calendar-view">
        <div class="calendar-grid">
            {{ $months := slice "January" "February" "March" "April" "May" "June" "July" "August" "September" "October" "November" "December" }}
            {{ range $month := $months }}
            <div class="month-box">
                <div class="month-header">{{ $month }}</div>
                <div class="month-events">
                    {{ $hasEvents := false }}
                    {{ range $.Site.Data.community }}
                    {{ if and (ne .dates "Ongoing") (ne .category "Online") }}
                    {{ if or (findRE (printf "^%s" $month) .dates) (findRE (printf "-%s" $month) .dates) }}
                    {{ $hasEvents = true }}
                    <div class="month-event">
                        <a href="{{ .url }}" target="_blank" rel="noopener">{{ .name }}</a>
                    </div>
                    {{ end }}
                    {{ end }}
                    {{ end }}
                    {{ if not $hasEvents }}
                    <span class="month-empty">No events</span>
                    {{ end }}
                </div>
            </div>
            {{ end }}
        </div>

        <!-- Always Available - Online Communities -->
        <div class="always-available">
            <h3>Always Available - Online Communities</h3>
            <div class="online-communities">
                {{ range .Site.Data.community }}
                {{ if eq .category "Online" }}
                <div class="online-community">
                    <a href="{{ .url }}" target="_blank" rel="noopener">{{ .name }}</a>
                    <span class="community-type">{{ .type }}</span>
                </div>
                {{ end }}
                {{ end }}
            </div>
        </div>
    </div>

    <!-- Cards View (hidden by default) -->
    <div id="cards-view" style="display: none;">
        <div class="resources-grid">
            {{ range $cat := $categoryOrder }}
            <div class="category-section" data-section-category="{{ $cat }}">
                <h2 class="category-title">{{ $cat }}</h2>
                <div class="cards-row">
                    {{ range $.Site.Data.community }}
                    {{ if eq .category $cat }}
                    <div class="resource-card"
                         data-name="{{ .name | lower }}"
                         data-description="{{ .description | lower }}"
                         data-category="{{ .category }}"
                         data-location="{{ .location | lower }}"
                         data-dates="{{ .dates | lower }}">
                        <div class="card-header">
                            <img class="resource-favicon"
                                 src="https://www.google.com/s2/favicons?domain={{ .url | replaceRE "^https?://([^/]+).*" "$1" }}&sz=32"
                                 alt=""
                                 loading="lazy"
                                 onerror="this.style.display='none'">
                            <h3 class="resource-name">
                                <a href="{{ .url }}" target="_blank" rel="noopener">{{ .name }}</a>
                            </h3>
                            <span class="resource-type">{{ .type }}</span>
                        </div>
                        <p class="resource-desc">{{ .description }}</p>
                        <div class="resource-meta">
                            <span class="meta-item">
                                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                    <circle cx="12" cy="10" r="3"></circle>
                                </svg>
                                {{ .location }}
                            </span>
                            <span class="meta-item">
                                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                                {{ .dates }}
                            </span>
                        </div>
                        <div class="card-footer">
                            <span class="category-badge">{{ .category }}</span>
                            <a href="{{ .url }}" target="_blank" class="link-btn">Visit</a>
                        </div>
                    </div>
                    {{ end }}
                    {{ end }}
                </div>
            </div>
            {{ end }}
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>Community resources for tech economists</p>
    </footer>
</div>

<script>
// Community page functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('community-search');
    const clearBtn = document.getElementById('clear-search');
    const categorySelect = document.getElementById('category-select');
    const calendarView = document.getElementById('calendar-view');
    const cardsView = document.getElementById('cards-view');
    const btnCalendar = document.getElementById('btn-calendar');
    const btnCards = document.getElementById('btn-cards');
    const cards = document.querySelectorAll('.resource-card');
    const sections = document.querySelectorAll('.category-section');
    const resultCount = document.getElementById('result-count');

    let activeCategory = 'all';
    let debounceTimer;

    // View toggle
    btnCalendar.addEventListener('click', function() {
        calendarView.style.display = 'block';
        cardsView.style.display = 'none';
        btnCalendar.classList.add('active');
        btnCards.classList.remove('active');
    });

    btnCards.addEventListener('click', function() {
        calendarView.style.display = 'none';
        cardsView.style.display = 'block';
        btnCards.classList.add('active');
        btnCalendar.classList.remove('active');
    });

    function filterItems() {
        const query = searchInput.value.toLowerCase().trim();
        let visibleCount = 0;

        // Filter cards
        cards.forEach(function(card) {
            const name = card.dataset.name || '';
            const desc = card.dataset.description || '';
            const category = card.dataset.category || '';
            const location = card.dataset.location || '';
            const dates = card.dataset.dates || '';

            const matchesSearch = !query ||
                name.includes(query) ||
                desc.includes(query) ||
                category.toLowerCase().includes(query) ||
                location.includes(query) ||
                dates.includes(query);

            const matchesCategory = activeCategory === 'all' || category === activeCategory;

            if (matchesSearch && matchesCategory) {
                card.classList.remove('hidden');
                card.classList.add('visible');
                visibleCount++;
            } else {
                card.classList.add('hidden');
                card.classList.remove('visible');
            }
        });

        // Update section visibility
        sections.forEach(function(section) {
            const visibleCards = section.querySelectorAll('.resource-card:not(.hidden)');
            if (visibleCards.length === 0) {
                section.classList.add('section-hidden');
            } else {
                section.classList.remove('section-hidden');
            }
        });

        // Update result count
        resultCount.textContent = visibleCount + ' events & communities';

        // Toggle clear button
        clearBtn.style.display = query ? 'flex' : 'none';
    }

    // Search input with debounce
    searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(filterItems, 150);
    });

    // Clear search
    clearBtn.addEventListener('click', function() {
        searchInput.value = '';
        filterItems();
        searchInput.focus();
    });

    // Category dropdown
    categorySelect.addEventListener('change', function() {
        activeCategory = this.value;
        filterItems();
    });
});
</script>
{{ end }}
